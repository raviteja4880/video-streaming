import{B as H,C as z,r as n,j as t,D as G,E as K,a as O,G as Y,o as q,v as J,L as Q,b as o,A as h}from"./index-B8jYU2_8.js";function ee(){var $,S;const{id:i}=H(),{user:r}=z(),[c,L]=n.useState(null),[p,C]=n.useState([]),[_,F]=n.useState([]),[y,E]=n.useState(""),[j,k]=n.useState(null),f=n.useRef(null),d=n.useRef(0),m=n.useRef(null),x=n.useRef(0),u=n.useRef(null);let T=0;const g=async()=>{try{const[e,s,a]=await Promise.all([o.get(`/videos/${i}`),o.get(`/comments/${i}`),o.get("/videos")]);L(e.data),C(s.data),F(a.data.filter(l=>l._id!==i).slice(0,6))}catch{h.error("Failed to load video")}};n.useEffect(()=>{g(),d.current=0,m.current=null,x.current=0,u.current&&clearInterval(u.current)},[i]);const U=async()=>{try{const e=`viewed_${i}_${(r==null?void 0:r.id)||"guest"}`;localStorage.getItem(e)||(await o.post(`/videos/${i}/view`),localStorage.setItem(e,"true"))}catch{}},P=async()=>{if(r)try{await o.post(`/history/${i}`)}catch{}},A=async e=>{if(!(e<=0))try{await o.post(`/videos/${i}/watchtime`,{secondsWatched:e})}catch(s){console.warn("Watch time sync failed:",s.message)}},I=()=>{U(),P(),m.current=Date.now(),u.current||(u.current=setInterval(()=>{const e=f.current;if(!e||e.paused||e.ended)return;const s=Date.now(),a=Math.floor((s-m.current)/1e3);d.current+=a,m.current=s;const l=d.current-x.current;l>=10&&(A(l),x.current=d.current)},5e3))},N=async()=>{if(!m.current)return;const e=Math.floor((Date.now()-m.current)/1e3);d.current+=e,m.current=null;const s=d.current-x.current;s>0&&(await A(s),x.current=d.current),b("pause")},b=e=>{k(e),setTimeout(()=>k(null),1e3)},v=e=>{const s=f.current;s&&(s.currentTime=Math.min(Math.max(0,s.currentTime+e),s.duration||1/0),b(e>0?"forward":"backward"))},D=e=>{const s=new Date().getTime();if(s-T<300&&e.targetTouches.length===1){const l=e.changedTouches[0].clientX,w=window.innerWidth;l<w/2?v(-10):v(10)}T=s};n.useEffect(()=>{const e=s=>{if(!(document.activeElement.tagName==="INPUT"||document.activeElement.tagName==="TEXTAREA")){if(s.code==="ArrowRight")s.preventDefault(),v(10);else if(s.code==="ArrowLeft")s.preventDefault(),v(-10);else if(s.code==="Space"){s.preventDefault();const a=f.current;if(!a)return;a.paused?a.play():(a.pause(),b("pause"))}}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),n.useEffect(()=>{const e=()=>{var a;const s=(a=f.current)==null?void 0:a.parentElement;document.fullscreenElement&&s?s.classList.add("fullscreen-active"):s==null||s.classList.remove("fullscreen-active")};return document.addEventListener("fullscreenchange",e),()=>document.removeEventListener("fullscreenchange",e)},[]),n.useEffect(()=>{const e=f.current;if(e)return e.addEventListener("touchend",D),()=>e.removeEventListener("touchend",D)},[]),n.useEffect(()=>{const e=async()=>{await N()};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[]),n.useEffect(()=>()=>{u.current&&(clearInterval(u.current),u.current=null)},[]);const M=async()=>{try{await o.post(`/videos/${i}/like`),g()}catch{h.error("Failed to like video")}},V=async()=>{try{await o.post(`/videos/${i}/share`),navigator.share?await navigator.share({title:c.title,url:window.location.href}):(await navigator.clipboard.writeText(window.location.href),h.info("Video link copied"))}catch{h.error("Failed to share video")}},W=async e=>{if(e.preventDefault(),!!y.trim())try{await o.post(`/comments/${i}`,{text:y}),E(""),g()}catch{h.error("Failed to post comment")}},B=async e=>{var a;const s=p.find(l=>l._id===e);if(s){if(!r||String((a=s.user)==null?void 0:a._id)!==String(r.id||r._id)){h.warn("You can only delete your own comments");return}try{await o.delete(`/comments/item/${e}`),g()}catch{h.error("Failed to delete comment")}}},R=e=>{const s=Math.floor((Date.now()-new Date(e))/1e3);return s<60?`${s}s ago`:s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:s<2592e3?`${Math.floor(s/86400)}d ago`:new Date(e).toLocaleDateString()};if(!c)return t.jsx("div",{className:"loading",children:"Loading..."});const X=r&&(($=c.likes)==null?void 0:$.includes(r.id||r._id));return t.jsx("div",{className:"video-page container-fluid py-4",children:t.jsxs("div",{className:"row gx-5 gy-4",children:[t.jsxs("div",{className:"col-lg-8",children:[t.jsxs("div",{className:"video-player-container shadow-sm mb-3 position-relative",children:[t.jsx("video",{ref:f,className:"video-player",src:c.url,controls:!0,poster:c.thumbnail||"",onPlay:I,onPause:N,onEnded:N,onDoubleClick:e=>{e.preventDefault();const s=e.target.getBoundingClientRect();e.clientX<s.left+s.width/2?v(-10):v(10)}}),j==="pause"&&t.jsx("div",{className:"video-symbol pause",children:t.jsxs("div",{className:"pause-bars",children:[t.jsx("div",{className:"bar left"}),t.jsx("div",{className:"bar right"})]})}),j==="forward"&&t.jsxs("div",{className:"video-symbol forward",children:[t.jsx(G,{className:"symbol-icon"}),t.jsx("span",{className:"symbol-text",children:"10"})]}),j==="backward"&&t.jsxs("div",{className:"video-symbol backward",children:[t.jsx(K,{className:"symbol-icon"}),t.jsx("span",{className:"symbol-text",children:"10"})]})]}),t.jsx("h3",{className:"video-title mt-3",children:c.title}),t.jsxs("p",{className:"text-secondary small mb-1",children:["Uploaded ",c.createdAt?R(c.createdAt):""]}),t.jsx("hr",{className:"video-divider"}),t.jsx("h6",{className:"text-light mb-2",children:"Description"}),t.jsx("p",{className:"text-secondary video-description",children:c.description}),t.jsxs("div",{className:"d-flex align-items-center gap-3 mt-3 video-actions",children:[t.jsxs("button",{className:`btn btn-like ${X?"liked":""}`,onClick:M,children:[t.jsx(O,{className:"me-2"})," ",((S=c.likes)==null?void 0:S.length)||0]}),t.jsxs("button",{className:"btn btn-share",onClick:V,children:[t.jsx(Y,{className:"me-2"})," Share"]}),t.jsxs("div",{className:"text-secondary d-flex align-items-center gap-1",children:[t.jsx(q,{})," ",c.views||0," views"]})]}),t.jsxs("div",{className:"comment-section mt-5 p-3 rounded shadow-sm",children:[t.jsxs("h5",{className:"mb-3 text-light",children:["Comments (",p.length,")"]}),r&&t.jsxs("form",{onSubmit:W,className:"d-flex mb-3 gap-2",children:[t.jsx("input",{className:"form-control bg-dark text-light border-0",value:y,onChange:e=>E(e.target.value),placeholder:"Add a comment..."}),t.jsx("button",{className:"btn btn-primary",children:"Post"})]}),t.jsx("div",{className:"comment-list",children:p.length>0?p.map(e=>{var s,a,l,w;return t.jsxs("div",{className:"comment-item d-flex align-items-start",children:[t.jsx("img",{src:((s=e.user)==null?void 0:s.avatar)||`https://ui-avatars.com/api/?name=${encodeURIComponent(((a=e.user)==null?void 0:a.name)||"User")}`,alt:(l=e.user)==null?void 0:l.name,className:"comment-avatar me-3"}),t.jsxs("div",{className:"comment-body flex-grow-1",children:[t.jsxs("div",{className:"comment-header",children:[t.jsxs("div",{className:"comment-info",children:[t.jsx("small",{className:"comment-author",children:((w=e.user)==null?void 0:w.name)||"Unknown User"}),t.jsx("small",{className:"comment-timestamp",children:e.createdAt?R(e.createdAt):""})]}),r&&e.user&&String(e.user._id)===String(r.id||r._id)&&t.jsx("button",{className:"icon-delete-btn",title:"Delete comment",onClick:()=>B(e._id),children:t.jsx(J,{size:15})})]}),t.jsx("p",{className:"comment-text mb-0",children:e.text})]})]},e._id)}):t.jsx("p",{className:"text-secondary small",children:"No comments yet. Be the first!"})})]})]}),t.jsx("div",{className:"col-lg-4",children:t.jsxs("div",{className:"related-section p-3 rounded shadow-sm",children:[t.jsx("h5",{className:"mb-3 text-light",children:"Related Videos"}),t.jsx("div",{className:"related-list",children:_.map(e=>{var s;return t.jsxs(Q,{to:`/video/${e._id}`,className:"related-item d-flex mb-3 text-decoration-none",children:[t.jsx("div",{className:"related-thumb me-3",children:t.jsx("video",{src:e.url,muted:!0,poster:e.thumbnail||""})}),t.jsxs("div",{className:"related-info",children:[t.jsx("p",{className:"related-title text-light mb-1",children:e.title}),t.jsx("small",{className:"text-secondary",children:((s=e.user)==null?void 0:s.name)||"Unknown"})]})]},e._id)})})]})})]})})}export{ee as default};
