import{B as z,C as G,r as a,j as t,D as K,E as O,p as Y,G as q,a as J,v as Q,L as Z,c as o,A as h}from"./index-DyDKpjxL.js";function te(){var $,L;const{id:i}=z(),{user:r}=G(),[c,C]=a.useState(null),[p,_]=a.useState([]),[F,U]=a.useState([]),[y,E]=a.useState(""),[j,k]=a.useState(null),v=a.useRef(null),R=a.useRef(null),d=a.useRef(0),m=a.useRef(null),x=a.useRef(0),u=a.useRef(null);let T=0;const g=async()=>{try{const[e,s,n]=await Promise.all([o.get(`/videos/${i}`),o.get(`/comments/${i}`),o.get("/videos")]);C(e.data),_(s.data),U(n.data.filter(l=>l._id!==i).slice(0,6))}catch{h.error("Failed to load video")}};a.useEffect(()=>{g(),d.current=0,m.current=null,x.current=0,u.current&&clearInterval(u.current)},[i]);const P=async()=>{try{const e=`viewed_${i}_${(r==null?void 0:r.id)||"guest"}`;localStorage.getItem(e)||(await o.post(`/videos/${i}/view`),localStorage.setItem(e,"true"))}catch{}},I=async()=>{if(r)try{await o.post(`/history/${i}`)}catch{}},A=async e=>{if(!(e<=0))try{await o.post(`/videos/${i}/watchtime`,{secondsWatched:e})}catch(s){console.warn("Watch time sync failed:",s.message)}},M=()=>{P(),I(),m.current=Date.now(),u.current||(u.current=setInterval(()=>{const e=v.current;if(!e||e.paused||e.ended)return;const s=Date.now(),n=Math.floor((s-m.current)/1e3);d.current+=n,m.current=s;const l=d.current-x.current;l>=10&&(A(l),x.current=d.current)},5e3))},N=async()=>{if(!m.current)return;const e=Math.floor((Date.now()-m.current)/1e3);d.current+=e,m.current=null;const s=d.current-x.current;s>0&&(await A(s),x.current=d.current),b("pause")},b=e=>{k(e),setTimeout(()=>k(null),800)},f=e=>{const s=v.current;s&&(s.currentTime=Math.min(Math.max(0,s.currentTime+e),s.duration||1/0),b(e>0?"forward":"backward"))},D=e=>{const s=new Date().getTime();if(s-T<300&&e.targetTouches.length===1){const l=e.changedTouches[0].clientX,w=window.innerWidth;l<w/2?f(-10):f(10)}T=s};a.useEffect(()=>{const e=s=>{if(document.activeElement.tagName==="INPUT"||document.activeElement.tagName==="TEXTAREA")return;const n=v.current;n&&(s.code==="ArrowRight"?(s.preventDefault(),f(10)):s.code==="ArrowLeft"?(s.preventDefault(),f(-10)):s.code==="Space"&&(s.preventDefault(),n.paused?n.play():(n.pause(),b("pause"))))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),a.useEffect(()=>{const e=()=>{const s=R.current;document.fullscreenElement&&s?s.classList.add("fullscreen-active"):s==null||s.classList.remove("fullscreen-active")};return document.addEventListener("fullscreenchange",e),()=>document.removeEventListener("fullscreenchange",e)},[]),a.useEffect(()=>{const e=v.current;if(e)return e.addEventListener("touchend",D),()=>e.removeEventListener("touchend",D)},[]),a.useEffect(()=>{const e=async()=>{await N()};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[]),a.useEffect(()=>()=>{u.current&&(clearInterval(u.current),u.current=null)},[]);const W=async()=>{try{await o.post(`/videos/${i}/like`),g()}catch{h.error("Failed to like video")}},B=async()=>{try{navigator.share?await navigator.share({title:c.title,url:window.location.href}):(await navigator.clipboard.writeText(window.location.href),h.info("Link copied to clipboard")),await o.post(`/videos/${i}/share`)}catch{h.error("Share failed")}},V=async e=>{if(e.preventDefault(),!!y.trim())try{await o.post(`/comments/${i}`,{text:y}),E(""),g()}catch{h.error("Failed to post comment")}},X=async e=>{var n;const s=p.find(l=>l._id===e);if(s){if(!r||String((n=s.user)==null?void 0:n._id)!==String(r.id||r._id)){h.warn("You can only delete your own comments");return}try{await o.delete(`/comments/item/${e}`),g()}catch{h.error("Failed to delete comment")}}},S=e=>{const s=Math.floor((Date.now()-new Date(e))/1e3);return s<60?`${s}s ago`:s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:s<2592e3?`${Math.floor(s/86400)}d ago`:new Date(e).toLocaleDateString()};if(!c)return t.jsx("div",{className:"loading",children:"Loading..."});const H=r&&(($=c.likes)==null?void 0:$.includes(r.id||r._id));return t.jsx("div",{className:"video-page container-fluid py-4",children:t.jsxs("div",{className:"row gx-5 gy-4",children:[t.jsxs("div",{className:"col-lg-8",children:[t.jsxs("div",{ref:R,className:"video-player-container position-relative shadow-sm",children:[t.jsx("video",{ref:v,className:"video-player",src:c.url,controls:!0,poster:c.thumbnail||"",onPlay:M,onPause:N,onEnded:N,onDoubleClick:e=>{e.preventDefault();const s=e.target.getBoundingClientRect();e.clientX<s.left+s.width/2?f(-10):f(10)}}),j==="pause"&&t.jsx("div",{className:"video-symbol pause active",children:t.jsxs("div",{className:"pause-bars",children:[t.jsx("div",{className:"bar left"}),t.jsx("div",{className:"bar right"})]})}),j==="forward"&&t.jsxs("div",{className:"video-symbol forward active",children:[t.jsx(K,{className:"symbol-icon"}),t.jsx("span",{className:"symbol-text",children:"10"})]}),j==="backward"&&t.jsxs("div",{className:"video-symbol backward active",children:[t.jsx(O,{className:"symbol-icon"}),t.jsx("span",{className:"symbol-text",children:"10"})]})]}),t.jsx("h3",{className:"video-title mt-3",children:c.title}),t.jsxs("p",{className:"text-secondary small mb-1",children:["Uploaded ",c.createdAt?S(c.createdAt):""]}),t.jsx("hr",{className:"video-divider"}),t.jsx("h6",{className:"text-light mb-2",children:"Description"}),t.jsx("p",{className:"text-secondary video-description",children:c.description}),t.jsxs("div",{className:"d-flex align-items-center gap-3 mt-3 video-actions",children:[t.jsxs("button",{className:`btn btn-like ${H?"liked":""}`,onClick:W,children:[t.jsx(Y,{className:"me-2"})," ",((L=c.likes)==null?void 0:L.length)||0]}),t.jsxs("button",{className:"btn btn-share",onClick:B,children:[t.jsx(q,{className:"me-2"})," Share"]}),t.jsxs("div",{className:"text-secondary d-flex align-items-center gap-1",children:[t.jsx(J,{})," ",c.views||0," views"]})]}),t.jsxs("div",{className:"comment-section mt-5 p-3 rounded shadow-sm",children:[t.jsxs("h5",{className:"mb-3 text-light",children:["Comments (",p.length,")"]}),r&&t.jsxs("form",{onSubmit:V,className:"d-flex mb-3 gap-2",children:[t.jsx("input",{className:"form-control bg-dark text-light border-0",value:y,onChange:e=>E(e.target.value),placeholder:"Add a comment..."}),t.jsx("button",{className:"btn btn-primary",children:"Post"})]}),t.jsx("div",{className:"comment-list",children:p.length>0?p.map(e=>{var s,n,l,w;return t.jsxs("div",{className:"comment-item d-flex align-items-start",children:[t.jsx("img",{src:((s=e.user)==null?void 0:s.avatar)||`https://ui-avatars.com/api/?name=${encodeURIComponent(((n=e.user)==null?void 0:n.name)||"User")}`,alt:(l=e.user)==null?void 0:l.name,className:"comment-avatar me-3"}),t.jsxs("div",{className:"comment-body flex-grow-1",children:[t.jsxs("div",{className:"comment-header",children:[t.jsxs("div",{className:"comment-info",children:[t.jsx("small",{className:"comment-author",children:((w=e.user)==null?void 0:w.name)||"Unknown User"}),t.jsx("small",{className:"comment-timestamp",children:e.createdAt?S(e.createdAt):""})]}),r&&e.user&&String(e.user._id)===String(r.id||r._id)&&t.jsx("button",{className:"icon-delete-btn",title:"Delete comment",onClick:()=>X(e._id),children:t.jsx(Q,{size:15})})]}),t.jsx("p",{className:"comment-text mb-0",children:e.text})]})]},e._id)}):t.jsx("p",{className:"text-secondary small",children:"No comments yet. Be the first!"})})]})]}),t.jsx("div",{className:"col-lg-4",children:t.jsxs("div",{className:"related-section p-3 rounded shadow-sm",children:[t.jsx("h5",{className:"mb-3 text-light",children:"Related Videos"}),t.jsx("div",{className:"related-list",children:F.map(e=>{var s;return t.jsxs(Z,{to:`/video/${e._id}`,className:"related-item d-flex mb-3 text-decoration-none",children:[t.jsx("div",{className:"related-thumb me-3",children:t.jsx("video",{src:e.url,muted:!0,poster:e.thumbnail||""})}),t.jsxs("div",{className:"related-info",children:[t.jsx("p",{className:"related-title text-light mb-1",children:e.title}),t.jsx("small",{className:"text-secondary",children:((s=e.user)==null?void 0:s.name)||"Unknown"})]})]},e._id)})})]})})]})})}export{te as default};
